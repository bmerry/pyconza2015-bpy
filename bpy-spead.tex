\documentclass{beamer}
\mode<presentation>
{
  \usetheme{Berkeley}
  \setbeamertemplate{footline}[frame number]
  \setbeamercovered{transparent}
}
\usepackage[english]{babel}
\usepackage[latin1]{inputenc}
\usepackage{times}
\usepackage[T1]{fontenc}
\usepackage{tikz}
\usepackage{booktabs}
\usepackage{multicol}
\usepackage{listings}
\usepackage[binary-units=true]{siunitx}
\usepackage{amsmath}
\usepackage{underscore}
\definecolor{lstpurple}{rgb}{0.5,0,0.35}
\definecolor{lstred}{rgb}{0.6,0,0}
\definecolor{lstgreen}{rgb}{0.25,0.5,0.35}
\definecolor{lstblue}{rgb}{0.25,0.35,0.75}
\newcommand\supertiny{\fontsize{3.5pt}{4.2}\selectfont}
\lstset{language = Python,
    showstringspaces = false,
    columns = flexible,
    basicstyle = \ttfamily\footnotesize,
    keywordstyle = \color{lstpurple},
    keywordstyle = [2]\color{lstblue},
    commentstyle = \color{lstgreen},
    stringstyle = \color{lstred},
    numbers=left,numberstyle=\tiny,numbersep=1ex
}

\title[Boost.Python]{How I learn to stop worrying and love Boost.Python}

\subtitle{An adventure in high-performance networking}

\author{Bruce Merry}
% - Give the names in the same order as the appear in the paper.
% - Use the \inst{?} command only if the authors have different
%   affiliation.

\institute[SKA SA]{SKA South Africa}

\date{PyCon ZA 2015}

% If you have a file called "university-logo-filename.xxx", where xxx
% is a graphic format that can be processed by latex or pdflatex,
% resp., then you can add a logo as follows:

% \pgfdeclareimage[height=0.5cm]{university-logo}{university-logo-filename}
% \logo{\pgfuseimage{university-logo}}



% Delete this, if you do not want the table of contents to pop up at
% the beginning of each subsection:
\AtBeginSubsection[]
{
  \begin{frame}<beamer>{Outline}
    \tableofcontents[currentsection,currentsubsection]
  \end{frame}
}


% If you wish to uncover everything in a step-wise fashion, uncomment
% the following command: 

%\beamerdefaultoverlayspecification{<+->}


\begin{document}

\begin{frame}
  \titlepage
\end{frame}

\begin{frame}{Outline}
  \tableofcontents
  % You might wish to add the option [pausesections]
\end{frame}

\section{Motivation}

\subsection{MeerKAT}

\subsection{SPEAD}

\begin{frame}{High-performance Networking}
  \alert{S}treaming \alert{P}rotocol for \alert{E}xchange of
  \alert{A}stronomical \alert{D}ata
  \begin{itemize}
    \item Generic, not astronomy-specific at all
    \item Used in MeerKAT for data (and occasionally metadata)
    \item Lossy one-way UDP transmission, multicast-friendly
  \end{itemize}
\end{frame}

\begin{frame}{Concepts}
  \begin{description}
    \item[Heap] Unit of transmission. Contains multiple items.
    \item[Item] Data in a numpy array.
    \item[Packet] UDP packet
  \end{description}
  Heaps are broken down into multiple packets
\end{frame}

\begin{frame}{Example}
  Correlator heaps at \SI{2}{\Hz}:
  \begin{itemize}
    \item \texttt{xeng_raw} $8320\times 32768\times 2\times \text{int32}$
    \item \texttt{timestamp} int
  \end{itemize}
  Each \SI{2}{\gibi\byte} heap is split into \SI{9}{\kilo\byte} packets.

  \pause
  Total rate is \SI{35}{Gbps} / \SI{475}{Kpps}.

  \pause
  In reality, will split this into several streams.
\end{frame}

\begin{frame}{Not Your Average High-Speed Networking}
  \begin{itemize}
    \item Large packets (MTU 9200)
    \item Small number of flows
    \item Bandwidth matters, latency doesn't
  \end{itemize}
\end{frame}

\begin{frame}{Just To Make It Interesting}
  I had some goals:
  \begin{itemize}
    \item Run without root privileges
    \item Run on Linux and OS X
  \end{itemize}
\end{frame}

% Add a slide giving examples of how sensitive things are
\section{Talking to C++}

\subsection{An Example C++ Library}

\begin{frame}[fragile=singleslide]{Code}
\begin{lstlisting}[language=c++]
namespace petshop
{

class Parrot
{
private:
    int volts;
public:
    void voom();
    void set_volts(int volts);
    int get_volts() const;
};

}
\end{lstlisting}
\end{frame}

\subsection{Python C API}

\begin{frame}[fragile]{A Small Example}
  \begin{lstlisting}[language=c++,
    basicstyle=\ttfamily\supertiny,
    numberstyle=\supertiny,
    multicols=2]
#include "Python.h"
#include "petshop.h"
#include <memory>

typedef struct {
    PyObject_HEAD
    petshop::Parrot wrapped;
} Parrot;

static PyTypeObject ParrotType = {
    PyVarObject_HEAD_INIT(NULL, 0)
    "capi_petshop.Parrot"
};

static PyObject *
Parrot_new(PyTypeObject *type, PyObject *args, PyObject *kwds) {
    Parrot *self = (Parrot *) type->tp_alloc(type, 0);
    if (self != NULL)
    {
        new (&self->wrapped) petshop::Parrot();
    }
    return (PyObject *) self;
}

static void Parrot_dealloc(Parrot *self) {
    self->wrapped.~Parrot();
    Py_TYPE(self)->tp_free((PyObject *) self);
}

static PyObject *Parrot_voom(Parrot *self) {
    self->wrapped.voom();
    Py_RETURN_NONE;
}

static PyObject *Parrot_get_volts(Parrot *self, void *closure) {
    return PyLong_FromLong(self->wrapped.get_volts());
}

static int
Parrot_set_volts(Parrot *self, PyObject *value, void *closure) {
    long volts = PyLong_AsLong(value);
    if (PyErr_Occurred())
        return -1;
    if (volts < INT_MIN || volts > INT_MAX) {
        PyErr_SetString(PyExc_OverflowError,
            "Python int too large to convert to C int");
        return -1;
    }
    self->wrapped.set_volts(volts);
    return 0;
}

static PyMethodDef Parrot_methods[] = {
    {"voom", (PyCFunction) Parrot_voom, METH_NOARGS, "voom"},
    {NULL}
};

static PyGetSetDef Parrot_getseters[] = {
    {"volts", (getter) Parrot_get_volts,
              (setter) Parrot_set_volts, "volts", NULL},
    {NULL}
};

static struct PyModuleDef capi_petshop_module = {
    PyModuleDef_HEAD_INIT,
    "capi_petshop",
    NULL,
    -1,
    NULL,
};

extern "C" {

PyMODINIT_FUNC PyInit_capi_petshop(void) {
    PyObject *m;
    ParrotType.tp_new = Parrot_new;
    ParrotType.tp_basicsize = sizeof(Parrot);
    ParrotType.tp_flags = Py_TPFLAGS_DEFAULT;
    ParrotType.tp_dealloc = (destructor) Parrot_dealloc;
    ParrotType.tp_methods = Parrot_methods;
    ParrotType.tp_getset = Parrot_getseters;
    if (PyType_Ready(&ParrotType) < 0)
        return NULL;
    m = PyModule_Create(&capi_petshop_module);
    if (m == NULL)
        return NULL;
    Py_INCREF(&ParrotType);
    PyModule_AddObject(m, "Parrot", (PyObject *) &ParrotType);
    return m;
}
}
  \end{lstlisting}
  \pause
  \only<2>{%
    \begin{tikzpicture}[remember picture,overlay]
      \node[inner sep=2cm,fill=gray!50!white,fill opacity=0.7,text opacity=1] at  (current page.center) {\Huge Never do this};
    \end{tikzpicture}%
  }%
\end{frame}

\subsection{Boost.Python}

\begin{frame}[fragile=singleslide]{Boost.Python}
  \begin{lstlisting}[language=c++]
#include <boost/python.hpp>
#include "petshop.h"

using namespace petshop;
using namespace boost::python;

BOOST_PYTHON_MODULE(bpy_petshop)
{
    class_<Parrot>("Parrot")
        .def("voom", &Parrot::voom)
        .add_property("volts",
            &Parrot::get_volts, &Parrot::set_volts);
}
  \end{lstlisting}
\end{frame}

% - The problem
%   - MeerKAT
%   - SPEAD
%   - High performance networking, but different
% - The approach
%   - Why Python
%     - we're a Python shop; protocol is based on numpy
%   - Why C++ (and how hard is it really?)
% - Possible solutions
%   - Pure Python
%   - ctypes, cffi
%   - Cython
%     - Show the compiler error
%   - Python C API
%     - Yuck!
%   - Boost.Python
%     - Show a noddy example
%     - Downside: a runtime system library dependency
% - The interesting stuff
%   - GIL
%     - GIL background
%   - Lifetime management (custodian and ward)
%   - KeyboardInterrupt
%   - asyncio
%   - logging
%   - exceptions
%   - bytestring conversion

\section*{Summary}

\begin{frame}{Summary}
  \begin{itemize}
    \item Fantastic for integrating C++ classes
    \item Can drop down to Python C API when needed
    \item No new language to learn
    \item Introduces a system library dependency
  \end{itemize}
\end{frame}

\end{document}
